<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp" rel="stylesheet">

<app-back-button></app-back-button>
<br><br>

<!-- Custom Alert Notification -->
<div *ngIf="customAlert" class="custom-alert-container" [class.show]="customAlert.show" [class.success]="customAlert.type === 'success'" [class.error]="customAlert.type === 'error'">
  <div class="custom-alert-cloud">
    <div class="custom-alert-content">
      <div class="custom-alert-icon">
        <i class="fas" [class.fa-check-circle]="customAlert.type === 'success'" [class.fa-exclamation-circle]="customAlert.type === 'error'"></i>
      </div>
      <p class="custom-alert-text">{{ customAlert.message }}</p>
    </div>
    <button class="custom-alert-close" (click)="closeCustomAlert()" type="button">
      <i class="fas fa-times"></i>
    </button>
  </div>
</div>

<div class="card">
  <h2>{{ 'items.items_by_domain.title' | translate }}</h2>
  <button class="add-domain-btn" (click)="showAddDomainDialog()">
    <span class="pi pi-plus"></span> {{ 'items.items_by_domain.add_domain_button' | translate }}
  </button>

  <div *ngFor="let domain of domains" class="domain-section">
    <div class="domain-header" (click)="toggleDomain(domain)">
      <span class="material-symbols-sharp">{{ domain.expanded ? 'expand_less' : 'expand_more' }}</span>
      <span class="domain-title">{{ getDomainLanguageField(domain, 'name') }}</span>
      <span class="item-count" [innerHTML]="'items.items_by_domain.item_count' | translate: { count: itemsByDomain[domain.id]!.length || 0 }"></span>
      <div class="domain-actions">
        <button pButton icon="pi pi-pencil" class="p-button-text p-button-rounded p-button-info" 
                [pTooltip]="'items.add_domain_dialog.tooltips.edit' | translate"
                (click)="showEditDomainDialog(domain); $event.stopPropagation()"></button>
        <button pButton icon="pi pi-trash" class="p-button-text p-button-rounded p-button-danger" 
                [pTooltip]="'items.add_domain_dialog.tooltips.delete' | translate"
                (click)="deleteDomain(domain); $event.stopPropagation()"></button>
      </div>
    </div>

    <div class="item-list" *ngIf="domain.expanded">
      <!-- Add Item Button and Form -->
      <div class="add-item-form-container">
        <button 
          class="toggle-add-item-btn" 
          (click)="toggleAddItemForm(domain); $event.stopPropagation()"
          type="button">
          <span class="material-symbols-sharp">{{ showAddItemForm[domain.id!] ? 'expand_less' : 'expand_more' }}</span>
          <span>{{ 'items.add_item_section.add_item_button' | translate }}</span>
        </button>
        
        <div class="add-item-form" *ngIf="showAddItemForm[domain.id!]">
          <div class="form-row-inline">
            <div class="form-group-inline">
              <label>{{ 'items.add_item_section.labels.item' | translate }}</label>
              <input type="text" 
                     class="inline-form-input"
                     [(ngModel)]="newItem.name" 
                     [placeholder]="'items.add_item_section.placeholders.item_title' | translate">
            </div>

            <div class="form-group-inline">
              <label>{{ 'items.add_item_section.labels.description' | translate }}</label>
              <input type="text" 
                     class="inline-form-input"
                     [(ngModel)]="newItem.description" 
                     [placeholder]="'items.add_item_section.placeholders.item_description' | translate">
            </div>
            
            <button pButton 
                    type="button" 
                    [label]="'items.add_item_section.add_item_button' | translate"
                    icon="pi pi-plus" 
                    class="add-item-btn-inline"
                    (click)="addItem(domain)"
                    [disabled]="!newItem.name || savingItem">
            </button>
          </div>
        </div>
      </div>

      <div class="item-header">
        <div class="col-item">{{ 'items.items_by_domain.headers.item' | translate }}</div>
        <div class="col-etat">{{ 'items.items_by_domain.headers.status' | translate }}</div>
        <div class="col-description">{{ 'items.items_by_domain.headers.description' | translate }}</div>
        <div class="col-ispeu">{{ 'items.items_by_domain.headers.ispeu' | translate }}</div>
        <div class="col-actions">{{ 'items.items_by_domain.headers.actions' | translate }}</div>
      </div>

      <div class="item-row" *ngFor="let item of itemsByDomain[domain.id]">
        <div class="col-item" data-label="Item">
          <div class="item-name-row">
            <span>{{ getItemLanguageField(item, 'name') }}</span>
            <button 
              *ngIf="getItemLanguageField(item, 'description')" 
              class="description-info-btn mobile-only" 
              (click)="showDescriptionPopup(item, $event)"
              [attr.aria-label]="'View description'"
              type="button">
              <i class="pi pi-info-circle"></i>
            </button>
          </div>
        </div>
        <div class="col-etat" data-label="Status">
          <span [class]="'status-badge status-' + item.etat.toLowerCase()">
            {{ getEtatLabel(item.etat) }}
          </span>
        </div>
        <div class="col-description desktop-only" data-label="Description">{{ getItemLanguageField(item, 'description') || ('items.items_by_domain.description_fallback' | translate) }}</div>
        <div class="col-ispeu" data-label="PEI">
          <p-inputSwitch [(ngModel)]="item.isPeu" (onChange)="toggleIsPeu(item, domain, $event)"></p-inputSwitch>
        </div>
        <div class="col-actions" data-label="Actions">
          <button pButton icon="pi pi-pencil" class="p-button-text p-button-rounded p-button-info" 
                  [pTooltip]="'items.add_item_dialog.tooltips.edit' | translate"
                  (click)="showEditItemDialog(item, domain)"></button>
          <button pButton icon="pi pi-trash" class="p-button-text p-button-rounded p-button-danger" 
                  [pTooltip]="'items.add_item_dialog.tooltips.delete' | translate"
                  (click)="deleteItem(item, domain)"></button>
        </div>
      </div>

      <div *ngIf="!itemsByDomain[domain.id]?.length" class="no-items">
        {{ 'items.items_by_domain.no_items' | translate }}
      </div>
    </div>
  </div>
</div>

<!-- Description Popup for Mobile -->
<div 
  *ngIf="selectedDescriptionItem" 
  class="description-popup-overlay"
  (click)="hideDescriptionPopup()">
  <div class="description-popup" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <h4>{{ getItemLanguageField(selectedDescriptionItem, 'name') }}</h4>
      <button class="popup-close-btn" (click)="hideDescriptionPopup()" type="button">
        <i class="pi pi-times"></i>
      </button>
    </div>
    <div class="popup-content">
      <p>{{ getItemLanguageField(selectedDescriptionItem, 'description') || ('items.items_by_domain.description_fallback' | translate) }}</p>
    </div>
  </div>
</div>

<!-- Add/Edit Domain Modal -->
<div *ngIf="displayAddDomainDialog" class="eval-modal-overlay" (click)="closeDomainDialog()">
  <div class="eval-modal" (click)="$event.stopPropagation()">
    <div class="eval-modal-header">
      <div class="eval-modal-header-content">
        <div class="eval-modal-icon-wrapper">
          <i class="fas fa-folder"></i>
        </div>
        <div class="eval-modal-title-wrapper">
          <h3 class="eval-modal-title">
            {{ isEditingDomain() ? ('items.add_domain_dialog.header_edit' | translate) : ('items.add_domain_dialog.header_add' | translate) }}
          </h3>
          <p class="eval-modal-subtitle">{{ 'items.add_domain_dialog.modal_subtitle' | translate }}</p>
        </div>
      </div>
      <button 
        type="button"
        class="eval-modal-close-btn"
        (click)="closeDomainDialog()"
        [attr.aria-label]="'items.add_domain_dialog.buttons.cancel' | translate">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="eval-modal-body">
      <form (ngSubmit)="isEditingDomain() ? updateDomain() : addDomain()">
        <div class="eval-form-group">
          <label for="domainName" class="eval-form-label">
            <i class="fas fa-heading"></i>
            <span>{{ 'items.add_domain_dialog.labels.title' | translate }}</span>
          </label>
          <input 
            id="domainName" 
            type="text" 
            [(ngModel)]="newDomain.name" 
            name="domainName"
            class="eval-form-input"
            [placeholder]="'items.add_domain_dialog.placeholders.title' | translate" 
            required />
        </div>

        <div class="eval-form-group">
          <label for="domainDesc" class="eval-form-label">
            <i class="fas fa-align-left"></i>
            <span>{{ 'items.add_domain_dialog.labels.description' | translate }}</span>
          </label>
          <input 
            id="domainDesc" 
            type="text" 
            [(ngModel)]="newDomain.description" 
            name="domainDesc"
            class="eval-form-input"
            [placeholder]="'items.add_domain_dialog.placeholders.description' | translate" />
        </div>

        <div class="eval-modal-footer">
          <button 
            type="button"
            class="eval-modal-btn-secondary"
            (click)="closeDomainDialog()">
            <i class="fas fa-times"></i>
            <span>{{ 'items.add_domain_dialog.buttons.cancel' | translate }}</span>
          </button>
          <button 
            type="submit"
            class="eval-modal-btn-primary"
            [disabled]="savingDomain">
            <i class="fas" [class.fa-plus]="!isEditingDomain()" [class.fa-save]="isEditingDomain()"></i>
            <span>{{ isEditingDomain() ? ('items.add_domain_dialog.buttons.update' | translate) : ('items.add_domain_dialog.buttons.add' | translate) }}</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add/Edit Item Modal -->
<div *ngIf="displayAddItemDialog" class="eval-modal-overlay" (click)="closeItemDialog()">
  <div class="eval-modal" (click)="$event.stopPropagation()">
    <div class="eval-modal-header">
      <div class="eval-modal-header-content">
        <div class="eval-modal-icon-wrapper">
          <i class="fas fa-list"></i>
        </div>
        <div class="eval-modal-title-wrapper">
          <h3 class="eval-modal-title">
            {{ isEditingItem() ? ('items.add_item_dialog.header_edit' | translate) : ('items.add_item_dialog.header_add' | translate) }}
          </h3>
          <p class="eval-modal-subtitle">{{ 'items.add_item_dialog.modal_subtitle' | translate }}</p>
        </div>
      </div>
      <button 
        type="button"
        class="eval-modal-close-btn"
        (click)="closeItemDialog()"
        [attr.aria-label]="'items.add_item_dialog.buttons.cancel' | translate">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="eval-modal-body">
      <form (ngSubmit)="isEditingItem() ? updateItem() : addItem()">
        <div class="eval-form-group">
          <label for="itemName" class="eval-form-label">
            <i class="fas fa-heading"></i>
            <span>{{ 'items.add_item_dialog.labels.title' | translate }}</span>
          </label>
          <input 
            id="itemName" 
            type="text" 
            [(ngModel)]="newItem.name" 
            name="itemName"
            class="eval-form-input"
            [placeholder]="'items.add_item_dialog.placeholders.title' | translate" 
            required />
        </div>

        <div class="eval-form-group">
          <label for="itemDesc" class="eval-form-label">
            <i class="fas fa-align-left"></i>
            <span>{{ 'items.add_item_dialog.labels.description' | translate }}</span>
          </label>
          <input 
            id="itemDesc" 
            type="text" 
            [(ngModel)]="newItem.description" 
            name="itemDesc"
            class="eval-form-input"
            [placeholder]="'items.add_item_dialog.placeholders.description' | translate" />
        </div>

        <div class="eval-form-group">
          <label for="itemEtat" class="eval-form-label">
            <i class="fas fa-check-circle"></i>
            <span>{{ 'items.add_item_dialog.labels.status' | translate }}</span>
          </label>
          <select 
            id="itemEtat" 
            [(ngModel)]="newItem.etat" 
            name="itemEtat"
            class="eval-form-select"
            required>
            <option [value]="''" disabled>{{ 'items.add_item_dialog.placeholders.status' | translate }}</option>
            <option *ngFor="let option of statusOptions" [value]="option.value">{{ option.label }}</option>
          </select>
        </div>

        <div class="eval-modal-footer">
          <button 
            type="button"
            class="eval-modal-btn-secondary"
            (click)="closeItemDialog()">
            <i class="fas fa-times"></i>
            <span>{{ 'items.add_item_dialog.buttons.cancel' | translate }}</span>
          </button>
          <button 
            type="submit"
            class="eval-modal-btn-primary"
            [disabled]="savingItem">
            <i class="fas" [class.fa-plus]="!isEditingItem()" [class.fa-save]="isEditingItem()"></i>
            <span>{{ isEditingItem() ? ('items.add_item_dialog.buttons.update' | translate) : ('items.add_item_dialog.buttons.add' | translate) }}</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Domain Confirmation Modal -->
<div *ngIf="showDeleteDomainModal" class="eval-modal-overlay" (click)="closeDeleteDomainModal()">
  <div class="eval-modal delete-modal" (click)="$event.stopPropagation()">
    <div class="eval-modal-header delete-modal-header">
      <div class="eval-modal-header-content">
        <div class="eval-modal-icon-wrapper delete-icon-wrapper">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="eval-modal-title-wrapper">
          <h3 class="eval-modal-title">
            {{ 'items.messages.confirm.delete_domain' | translate: { domainName: domainToDelete ? getDomainLanguageField(domainToDelete, 'name') : '' } }}
          </h3>
        </div>
      </div>
      <button 
        type="button"
        class="eval-modal-close-btn"
        (click)="closeDeleteDomainModal()"
        [attr.aria-label]="'items.add_domain_dialog.buttons.cancel' | translate">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="eval-modal-footer">
      <button 
        type="button"
        class="eval-modal-btn-secondary"
        (click)="closeDeleteDomainModal()">
        <i class="fas fa-times"></i>
        <span>{{ 'items.add_domain_dialog.buttons.cancel' | translate }}</span>
      </button>
      <button 
        type="button"
        class="eval-modal-btn-danger"
        (click)="confirmDeleteDomain()">
        <i class="fas fa-trash-alt"></i>
        <span>{{ 'items.messages.confirm.delete_button' | translate }}</span>
      </button>
    </div>
  </div>
</div>

<!-- Delete Item Confirmation Modal -->
<div *ngIf="showDeleteItemModal" class="eval-modal-overlay" (click)="closeDeleteItemModal()">
  <div class="eval-modal delete-modal" (click)="$event.stopPropagation()">
    <div class="eval-modal-header delete-modal-header">
      <div class="eval-modal-header-content">
        <div class="eval-modal-icon-wrapper delete-icon-wrapper">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="eval-modal-title-wrapper">
          <h3 class="eval-modal-title">
            {{ 'items.messages.confirm.delete_item' | translate: { itemName: itemToDelete ? getItemLanguageField(itemToDelete.item, 'name') : '' } }}
          </h3>
        </div>
      </div>
      <button 
        type="button"
        class="eval-modal-close-btn"
        (click)="closeDeleteItemModal()"
        [attr.aria-label]="'items.add_item_dialog.buttons.cancel' | translate">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="eval-modal-footer">
      <button 
        type="button"
        class="eval-modal-btn-secondary"
        (click)="closeDeleteItemModal()">
        <i class="fas fa-times"></i>
        <span>{{ 'items.add_item_dialog.buttons.cancel' | translate }}</span>
      </button>
      <button 
        type="button"
        class="eval-modal-btn-danger"
        (click)="confirmDeleteItem()">
        <i class="fas fa-trash-alt"></i>
        <span>{{ 'items.messages.confirm.delete_button' | translate }}</span>
      </button>
    </div>
  </div>
</div>