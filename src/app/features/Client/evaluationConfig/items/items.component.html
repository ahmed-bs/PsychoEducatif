<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp" rel="stylesheet">

<div class="back-button" (click)="goBack()">
  <span class="material-symbols-sharp">arrow_back</span>
</div>
<br><br>

<p-toast></p-toast>

<div class="card">
  <div class="add-item-section">
    <h2>{{ 'items.add_item_section.title' | translate }}</h2>
    
    <div class="form-row">
      <div class="form-group">
        <label>{{ 'items.add_item_section.labels.domain' | translate }}</label>
        <p-dropdown [options]="domainsWithDisplayNames" 
                   [(ngModel)]="selectedDomain" 
                   optionLabel="displayName" 
                   [placeholder]="'items.add_item_section.placeholders.domain' | translate"
                   [style]="{'width':'100%'}">
        </p-dropdown>
      </div>
      
      <div class="form-group item-input">
        <label>{{ 'items.add_item_section.labels.item' | translate }}</label>
        <input type="text" 
               pInputText 
               [(ngModel)]="newItem.name" 
               [placeholder]="'items.add_item_section.placeholders.item_title' | translate"
               [style]="{'width':'100%'}">
      </div>

      <div class="form-group item-input">
        <label>{{ 'items.add_item_section.labels.description' | translate }}</label>
        <input type="text" 
               pInputText 
               [(ngModel)]="newItem.description" 
               [placeholder]="'items.add_item_section.placeholders.item_description' | translate"
               [style]="{'width':'100%'}">
      </div>
      
      <button pButton 
              type="button" 
              [label]="'items.add_item_section.add_item_button' | translate"
              icon="pi pi-plus" 
              class="add-item-btn"
              (click)="addItem()"
              [disabled]="!selectedDomain || !newItem.name">
      </button>
    </div>
  </div>
</div>

<div class="card">
  <h2>{{ 'items.items_by_domain.title' | translate }}</h2>
  <button class="add-domain-btn" (click)="showAddDomainDialog()">
    <span class="pi pi-plus"></span> {{ 'items.items_by_domain.add_domain_button' | translate }}
  </button>

  <div *ngFor="let domain of domains" class="domain-section">
    <div class="domain-header" (click)="toggleDomain(domain)">
      <span class="material-symbols-sharp">{{ domain.expanded ? 'expand_less' : 'expand_more' }}</span>
      <span class="domain-title">{{ getDomainLanguageField(domain, 'name') }}</span>
      <span class="item-count" [innerHTML]="'items.items_by_domain.item_count' | translate: { count: itemsByDomain[domain.id]!.length || 0 }"></span>
      <div class="domain-actions">
        <button pButton icon="pi pi-pencil" class="p-button-text p-button-rounded p-button-info" 
                [pTooltip]="'items.add_domain_dialog.tooltips.edit' | translate"
                (click)="showEditDomainDialog(domain); $event.stopPropagation()"></button>
        <button pButton icon="pi pi-trash" class="p-button-text p-button-rounded p-button-danger" 
                [pTooltip]="'items.add_domain_dialog.tooltips.delete' | translate"
                (click)="deleteDomain(domain); $event.stopPropagation()"></button>
      </div>
    </div>

    <div class="item-list" *ngIf="domain.expanded">
      <div class="item-header">
        <div class="col-item">{{ 'items.items_by_domain.headers.item' | translate }}</div>
        <div class="col-etat">{{ 'items.items_by_domain.headers.status' | translate }}</div>
        <div class="col-description">{{ 'items.items_by_domain.headers.description' | translate }}</div>
        <div class="col-ispeu">{{ 'items.items_by_domain.headers.ispeu' | translate }}</div>
        <div class="col-actions">{{ 'items.items_by_domain.headers.actions' | translate }}</div>
      </div>

      <div class="item-row" *ngFor="let item of itemsByDomain[domain.id]">
        <div class="col-item">{{ getItemLanguageField(item, 'name') }}</div>
        <div class="col-etat">
          <span [class]="'status-badge status-' + item.etat.toLowerCase()">
            {{ getEtatLabel(item.etat) }}
          </span>
        </div>
        <div class="col-description">{{ getItemLanguageField(item, 'description') || ('items.items_by_domain.description_fallback' | translate) }}</div>
        <div class="col-ispeu">
          <p-inputSwitch [(ngModel)]="item.isPeu" (onChange)="toggleIsPeu(item, domain, $event)"></p-inputSwitch>
        </div>
        <div class="col-actions">
          <button pButton icon="pi pi-pencil" class="p-button-text p-button-rounded p-button-info" 
                  [pTooltip]="'items.add_item_dialog.tooltips.edit' | translate"
                  (click)="showEditItemDialog(item, domain)"></button>
          <button pButton icon="pi pi-trash" class="p-button-text p-button-rounded p-button-danger" 
                  [pTooltip]="'items.add_item_dialog.tooltips.delete' | translate"
                  (click)="deleteItem(item, domain)"></button>
        </div>
      </div>

      <div *ngIf="!itemsByDomain[domain.id]?.length" class="no-items">
        {{ 'items.items_by_domain.no_items' | translate }}
      </div>
    </div>
  </div>
</div>

<!-- Add Domain Dialog -->
<p-dialog [(visible)]="displayAddDomainDialog" [modal]="true" [style]="{ width: '40vw' }" [draggable]="false" [resizable]="false">
  <ng-template pTemplate="header">
    <div class="custom-dialog-header">
      <h2>{{ isEditingDomain() ? ('items.add_domain_dialog.header_edit' | translate) : ('items.add_domain_dialog.header_add' | translate) }}</h2>
    </div>
  </ng-template>
  <div class="dialog-content">
    <div class="field">
      <label for="domainName">{{ 'items.add_domain_dialog.labels.title' | translate }}</label>
      <input pInputText id="domainName" [(ngModel)]="newDomain.name" [placeholder]="'items.add_domain_dialog.placeholders.title' | translate" />
    </div>
    <div class="field">
      <label for="domainDesc">{{ 'items.add_domain_dialog.labels.description' | translate }}</label>
      <input pInputText id="domainDesc" [(ngModel)]="newDomain.description" [placeholder]="'items.add_domain_dialog.placeholders.description' | translate" />
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button [label]="'items.add_domain_dialog.buttons.cancel' | translate" styleClass="p-button-text" (click)="closeDomainDialog()"></p-button>
    <p-button [label]="isEditingDomain() ? ('items.add_domain_dialog.buttons.update' | translate) : ('items.add_domain_dialog.buttons.add' | translate)" styleClass="p-button-primary" (click)="isEditingDomain() ? updateDomain() : addDomain()" [style]="{ color: 'white' }"></p-button>
  </ng-template>
</p-dialog>

<!-- Edit Item Dialog -->
<p-dialog [(visible)]="displayAddItemDialog" [modal]="true" [style]="{ width: '40vw' }" [draggable]="false" [resizable]="false">
  <ng-template pTemplate="header">
    <div class="custom-dialog-header">
      <h2>{{ isEditingItem() ? ('items.add_item_dialog.header_edit' | translate) : ('items.add_item_dialog.header_add' | translate) }}</h2>
    </div>
  </ng-template>
  <div class="dialog-content">
    <div class="field">
      <label for="itemName">{{ 'items.add_item_dialog.labels.title' | translate }}</label>
      <input pInputText id="itemName" [(ngModel)]="newItem.name" [placeholder]="'items.add_item_dialog.placeholders.title' | translate" />
    </div>
    <div class="field">
      <label for="itemDesc">{{ 'items.add_item_dialog.labels.description' | translate }}</label>
      <input pInputText id="itemDesc" [(ngModel)]="newItem.description" [placeholder]="'items.add_item_dialog.placeholders.description' | translate" />
    </div>
    <div class="field">
      <label for="itemEtat">{{ 'items.add_item_dialog.labels.status' | translate }}</label>
      <p-dropdown id="itemEtat" 
                 [options]="statusOptions"
                 [(ngModel)]="newItem.etat" 
                 [placeholder]="'items.add_item_dialog.placeholders.status' | translate">
      </p-dropdown>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button [label]="'items.add_item_dialog.buttons.cancel' | translate" styleClass="p-button-text" (click)="closeItemDialog()"></p-button>
    <p-button [label]="isEditingItem() ? ('items.add_item_dialog.buttons.update' | translate) : ('items.add_item_dialog.buttons.add' | translate)" styleClass="p-button-primary" (click)="isEditingItem() ? updateItem() : addItem()" [style]="{ color: 'white' }"></p-button>
  </ng-template>
</p-dialog>