<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp" rel="stylesheet">

<div class="head-title">
  <div class="left">
    <h1><span class="emoji">üìù</span> {{ 'categories.head_title.title' | translate }}</h1>
    <ul class="breadcrumb">
      <li><a href="#">{{ 'categories.head_title.breadcrumb.dashboard' | translate }}</a></li>
      <li><i class="bx bx-chevron-right"></i></li>
      <li><a class="active" href="#"><span class="emoji">üìù</span> {{ 'categories.head_title.breadcrumb.skills_list' | translate }}</a></li>
    </ul>
  </div>
</div>

<p-toast></p-toast>

<div class="p-3">
  <div class="flex col justify-end">
    <p-toolbar>
      <ng-template pTemplate="left">
        <div class="view-mode-buttons">
          <button 
            pButton 
            icon="pi pi-th-large" 
            [class.active]="viewMode === 'grid'"
            (click)="setViewMode('grid')"
            class="p-button-text view-mode-btn"
            >
          </button>
          <button 
            pButton 
            icon="pi pi-list" 
            [class.active]="viewMode === 'list'"
            (click)="setViewMode('list')"
            class="p-button-text view-mode-btn"
           >
          </button>
          <button 
            *ngIf="!isMobile"
            pButton 
            icon="pi pi-table" 
            [class.active]="viewMode === 'table'"
            (click)="setViewMode('table')"
            class="p-button-text view-mode-btn"
           >
          </button>
        </div>
      </ng-template>
      <ng-template pTemplate="right">
        <button pButton icon="pi pi-plus" class="p-button-add" (click)="showAddUserDialog()">
        </button>
      </ng-template>
    </p-toolbar>
  </div>
</div>

<div class="container">
  <main>
    <!-- Grid View (Original Card Layout) -->
    <div *ngIf="viewMode === 'grid'" class="insights">
      <!-- Display image if no categories -->
      <div *ngIf="!categories || categories.length === 0" class="no-data">
        <img src="/assets/image/nodatafound.png" [alt]="'categories.no_data.image_alt' | translate" class="no-data-image" />
        <p>{{ 'categories.no_data.message' | translate }}</p>
      </div>
      <!-- Display categories if available -->
      <ng-container *ngIf="categories && categories.length > 0">
        <div class="sales" *ngFor="let category of categories">
          <button class="btn top-right" (click)="showEditDialog(category)">‚úèÔ∏è</button>
          <span class="material-symbols-sharp">category</span>
          <div class="middle">
            <div class="left">
              <h2>{{ getLanguageField(category, 'name') }}</h2>
              <h3 [innerHTML]="'categories.category_card.created_at' | translate: { date: (category.created_at | date: 'dd/MM/yyyy') }"></h3>
            </div>
          </div>
          <small class="text-muted" [innerHTML]="'categories.category_card.items_count' | translate: { count: category.items_count || 0 }"></small>
          <small class="text-muted" [innerHTML]="'categories.category_card.domains_count' | translate: { count: category.domains_count || 0 }"></small>
          <br />
          <div class="buttons">
            <button class="btn delete" (click)="deleteCategory(category)">üóë</button>
            <button class="btn edit" (click)="navigateToDomains(category)">‚öôÔ∏è</button>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- List View -->
    <div *ngIf="viewMode === 'list'" class="list-view">
      <!-- Display image if no categories -->
      <div *ngIf="!categories || categories.length === 0" class="no-data">
        <img src="/assets/image/nodatafound.png" [alt]="'categories.no_data.image_alt' | translate" class="no-data-image" />
        <p>{{ 'categories.no_data.message' | translate }}</p>
      </div>
      <!-- Display categories if available -->
      <ng-container *ngIf="categories && categories.length > 0">
        <div class="list-item" *ngFor="let category of categories">
          <div class="list-item-content">
            <div class="list-item-icon">
              <span class="material-symbols-sharp">category</span>
            </div>
            <div class="list-item-details">
              <div class="title-row">
                <h3>{{ getLanguageField(category, 'name') }}</h3>
                <button 
                  *ngIf="getLanguageField(category, 'description')" 
                  class="description-info-btn mobile-only" 
                  (click)="showDescriptionPopup(category, $event)"
                  [attr.aria-label]="'View description'"
                  type="button">
                  <i class="pi pi-info-circle"></i>
                </button>
              </div>
              <p class="description desktop-only">{{ getLanguageField(category, 'description') || 'No description' }}</p>
              <div class="meta-info">
                <span class="meta-item">
                  <i class="pi pi-calendar"></i>
                  {{ category.created_at | date: 'dd/MM/yyyy' }}
                </span>
                <span class="meta-item">
                  <i class="pi pi-list"></i>
                  {{ category.items_count || 0 }} items
                </span>
                <span class="meta-item">
                  <i class="pi pi-folder"></i>
                  {{ category.domains_count || 0 }} domains
                </span>
              </div>
            </div>
            <div class="list-item-actions">
              <button class="btn edit" (click)="showEditDialog(category)" title="Edit">
                <i class="pi pi-pencil"></i>
              </button>
              <button class="btn settings" (click)="navigateToDomains(category)" title="Settings">
                <i class="pi pi-cog"></i>
              </button>
              <button class="btn delete" (click)="deleteCategory(category)" title="Delete">
                <i class="pi pi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- Description Popup for Mobile -->
    <div 
      *ngIf="selectedDescriptionCategory" 
      class="description-popup-overlay"
      (click)="hideDescriptionPopup()">
      <div class="description-popup" (click)="$event.stopPropagation()">
        <div class="popup-header">
          <h4>{{ getLanguageField(selectedDescriptionCategory, 'name') }}</h4>
          <button class="popup-close-btn" (click)="hideDescriptionPopup()" type="button">
            <i class="pi pi-times"></i>
          </button>
        </div>
        <div class="popup-content">
          <p>{{ getLanguageField(selectedDescriptionCategory, 'description') || 'No description' }}</p>
        </div>
      </div>
    </div>

    <!-- Table View -->
    <div *ngIf="viewMode === 'table' && !isMobile" class="table-view">
      <!-- Display image if no categories -->
      <div *ngIf="!categories || categories.length === 0" class="no-data">
        <img src="/assets/image/nodatafound.png" [alt]="'categories.no_data.image_alt' | translate" class="no-data-image" />
        <p>{{ 'categories.no_data.message' | translate }}</p>
      </div>
      <!-- Display table if categories available -->
      <ng-container *ngIf="categories && categories.length > 0">
        <p-table 
          [value]="categories" 
          [loading]="loading"
          styleClass="p-datatable-sm"
          [tableStyle]="{'min-width': '50rem'}"
          [paginator]="true" 
          [rows]="10"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
          [rowsPerPageOptions]="[5,10,25,50]">
          
          <ng-template pTemplate="header">
            <tr>
              <th>{{ 'categories.table.headers.name' | translate }}</th>
              <th>{{ 'categories.table.headers.description' | translate }}</th>
              <th>{{ 'categories.table.headers.created_at' | translate }}</th>
              <th>{{ 'categories.table.headers.items_count' | translate }}</th>
              <th>{{ 'categories.table.headers.domains_count' | translate }}</th>
              <th>{{ 'categories.table.headers.actions' | translate }}</th>
            </tr>
          </ng-template>
          
          <ng-template pTemplate="body" let-category>
            <tr>
              <td>
                <div class="category-name">
                  <span class="material-symbols-sharp category-icon">category</span>
                  {{ getLanguageField(category, 'name') }}
                </div>
              </td>
              <td>{{ getLanguageField(category, 'description') || '-' }}</td>
              <td>{{ category.created_at | date: 'dd/MM/yyyy' }}</td>
              <td>
                <span class="badge items-badge">{{ category.items_count || 0 }}</span>
              </td>
              <td>
                <span class="badge domains-badge">{{ category.domains_count || 0 }}</span>
              </td>
              <td>
                <div class="table-actions">
                  <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-text p-button-sm" 
                          (click)="showEditDialog(category)" 
                          >
                  </button>
                  <button pButton icon="pi pi-cog" class="p-button-rounded p-button-text p-button-sm" 
                          (click)="navigateToDomains(category)" 
                          >
                  </button>
                  <button pButton icon="pi pi-trash" class="p-button-rounded p-button-text p-button-danger p-button-sm" 
                          (click)="deleteCategory(category)" 
                         >
                  </button>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </ng-container>
    </div>
  </main>
</div>

<!-- Add/Edit Category Dialog -->
<p-dialog [(visible)]="displayAddUserDialog" [modal]="true" [style]="{ width: '40vw' }" [draggable]="false" [resizable]="false">
  <ng-template pTemplate="header">
    <div class="custom-dialog-header">
      <h2>{{ (newCategory.id ? 'categories.add_category_dialog.header_edit' : 'categories.add_category_dialog.header_add') | translate }}</h2>
    </div>
  </ng-template>
  <div class="dialog-content">
    <!-- Language-specific form fields -->
    <div *ngIf="getCurrentLanguage() === 'ar'" class="field">
      <label for="categoryNameAr">{{ 'categories.add_category_dialog.labels.title_ar' | translate }}</label>
      <input pInputText id="categoryNameAr" [(ngModel)]="newCategory.name" [placeholder]="'categories.add_category_dialog.placeholders.title_ar' | translate" />
    </div>
    <div *ngIf="getCurrentLanguage() === 'ar'" class="field">
      <label for="categoryDescriptionAr">{{ 'categories.add_category_dialog.labels.description_ar' | translate }}</label>
      <textarea pInputTextarea id="categoryDescriptionAr" [(ngModel)]="newCategory.description" [placeholder]="'categories.add_category_dialog.placeholders.description_ar' | translate" rows="3"></textarea>
    </div>
    
    <div *ngIf="getCurrentLanguage() === 'en'" class="field">
      <label for="categoryNameEn">{{ 'categories.add_category_dialog.labels.title_en' | translate }}</label>
      <input pInputText id="categoryNameEn" [(ngModel)]="newCategory.name" [placeholder]="'categories.add_category_dialog.placeholders.title_en' | translate" />
    </div>
    <div *ngIf="getCurrentLanguage() === 'en'" class="field">
      <label for="categoryDescriptionEn">{{ 'categories.add_category_dialog.labels.description_en' | translate }}</label>
      <textarea pInputTextarea id="categoryDescriptionEn" [(ngModel)]="newCategory.description" [placeholder]="'categories.add_category_dialog.placeholders.description_en' | translate" rows="3"></textarea>
    </div>
    
    <div *ngIf="getCurrentLanguage() === 'fr'" class="field">
      <label for="categoryName">{{ 'categories.add_category_dialog.labels.title' | translate }}</label>
      <input pInputText id="categoryName" [(ngModel)]="newCategory.name" [placeholder]="'categories.add_category_dialog.placeholders.title' | translate" />
    </div>
    <div *ngIf="getCurrentLanguage() === 'fr'" class="field">
      <label for="categoryDescription">{{ 'categories.add_category_dialog.labels.description' | translate }}</label>
      <textarea pInputTextarea id="categoryDescription" [(ngModel)]="newCategory.description" [placeholder]="'categories.add_category_dialog.placeholders.description' | translate" rows="3"></textarea>
    </div>
    
    <div class="field-info">
      <small class="text-muted">{{ 'categories.add_category_dialog.info.at_least_one_name' | translate }}</small>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button [label]="'categories.add_category_dialog.buttons.cancel' | translate" styleClass="p-button-text" (click)="displayAddUserDialog = false"></p-button>
    <p-button [label]="(newCategory.id ? 'categories.add_category_dialog.buttons.update' : 'categories.add_category_dialog.buttons.add') | translate" styleClass="p-button-primary" (click)="saveCategory()" [style]="{ color: 'white' }"></p-button>
  </ng-template>
</p-dialog>

<!-- Delete Confirmation Dialog -->
<p-dialog [(visible)]="displayDeleteDialog" [modal]="true" [style]="{ width: '30vw' }" [draggable]="false" [resizable]="false">
  <ng-template pTemplate="header">
    <div class="custom-dialog-header">
      <h2>{{ 'categories.delete_dialog.header' | translate }}</h2>
    </div>
  </ng-template>
  <div class="dialog-content">
    <div class="delete-confirmation">
      <i class="pi pi-exclamation-triangle" style="font-size: 2rem; color: #e53e78; margin-bottom: 1rem;"></i>
      <p>{{ 'categories.delete_dialog.message' | translate: { categoryName: categoryToDelete ? getLanguageField(categoryToDelete, 'name') : '' } }}</p>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button [label]="'categories.delete_dialog.buttons.cancel' | translate" styleClass="p-button-text" (click)="displayDeleteDialog = false"></p-button>
    <p-button [label]="'categories.delete_dialog.buttons.delete' | translate" styleClass="p-button-danger" (click)="confirmDelete()"></p-button>
  </ng-template>
</p-dialog>