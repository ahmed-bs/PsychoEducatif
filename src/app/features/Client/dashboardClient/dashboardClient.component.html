<div class="container">
    <!-- ================== Start OF MAIN ================== -->
    <main>
        <div class="head-title">
            <div class="left">
                <h1>üè† Bienvenue sur le Tableau de Bord</h1>
                <ul class="breadcrumb">
                    <li>
                        <a href="#">Tableau de bord</a>
                    </li>
                    <li><i class="bx bx-chevron-right"></i></li>
                    <li>
                        <a class="active" href="#">Tableau de Bord</a>
                    </li>
                </ul>
            </div>
            <div class="right">

            </div>
        </div>

        <body class="bg-gray-50 font-sans">
            <div class="container mx-auto px-2 sm:px-4 md:px-8 py-4 max-w-6xl">
                <!-- Header -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                    <h1 class="text-2xl md:text-3xl font-bold text-indigo-800"></h1>
                    <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                        <!-- Dropdown for child profiles -->
                        <div class="dropdown relative w-full sm:w-auto">
                            <div class="dropdown-content mt-1">
                                <div *ngFor="let child of filteredChildren" class="dropdown-item"
                                    [class.active]="child.id === selectedChild?.id">
                                    <div
                                        class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                                        <i class="fas fa-child text-indigo-600"></i>
                                    </div>
                                    <div>
                                        <div class="font-medium">{{ child.first_name }} {{ child.last_name }}</div>
                                        <div class="text-xs text-gray-500">{{ calculateAge(child.birth_date) }} ‚Ä¢ {{
                                            child.diagnosis || 'Non sp√©cifi√©' }}</div>
                                    </div>
                                </div>
                                <div class="border-t border-gray-200"></div>
                                <div class="dropdown-item">
                                    <i class="fas fa-plus-circle text-indigo-600 mr-3"></i>
                                    <div class="font-medium text-indigo-600" (click)="showDialog()">Ajouter un nouveau
                                        profil</div>
                                </div>
                            </div>

                        </div>
                        <button
                            class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center w-full sm:w-auto">
                            <i class="fas fa-file-pdf mr-2"></i> Exporter PDF
                        </button>

                    </div>
                </div>

                <!-- Profile Card -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
                    <div class="flex flex-col md:flex-row">
                        <div class="md:w-1/4 bg-indigo-100 p-6 flex flex-col items-center justify-center">
                            <div class="w-24 h-24 md:w-32 md:h-32 rounded-full bg-indigo-200 flex items-center justify-center mb-4">
                                <i class="fas fa-child text-4xl md:text-6xl text-indigo-600"></i>
                            </div>
                            <button class="text-indigo-600 hover:text-indigo-800 flex items-center">
                                <i class="fas fa-camera mr-2"></i> Ajouter photo
                            </button>
                        </div>
                        <div class="md:w-3/4 p-4 md:p-6" *ngIf="selectedChild">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div>
                                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">{{ selectedChild.first_name }} {{
                                        selectedChild.last_name }}
                                    </h2>
                                    <div class="flex flex-wrap items-center mt-2 gap-2">
                                        <span
                                            class="bg-blue-100 text-blue-800 text-xs md:text-sm font-medium px-2.5 py-0.5 rounded">{{
                                            calculateAge(selectedChild.birth_date) }}</span>
                                        <span
                                            class="bg-purple-100 text-purple-800 text-xs md:text-sm font-medium px-2.5 py-0.5 rounded">{{
                                            selectedChild.gender === 'M' ? '‚ôÇ Male' : '‚ôÄ Female' }}</span>
                                    </div>
                                    <p class="text-gray-600 mt-2 text-xs md:text-base"><i
                                            class="fas fa-calendar-alt mr-2 text-indigo-500"></i> Derni√®re
                                        √©valuation: 15/06/2023</p>
                                </div>
                                <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                                    <button (click)="showShareDialog()"
                                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center w-full sm:w-auto">
                                        <i class="fas fa-share-alt mr-2"></i> Partager le profil
                                    </button>
                                </div>
                            </div>

                            <!-- Tabs -->
                            <div class="border-b border-gray-200 mt-4">
                                <ul class="flex flex-wrap -mb-px overflow-x-auto md:overflow-visible">
                                    <li class="mr-2" *ngFor="let tab of tabs">
                                        <button class="inline-block p-2 md:p-4 border-b-2 rounded-t-lg font-medium text-xs md:text-base"
                                            [class.border-indigo-600]="isTabActive(tab.id)"
                                            [class.text-indigo-600]="isTabActive(tab.id)"
                                            [class.border-transparent]="!isTabActive(tab.id)"
                                            [class.hover:text-gray-600]="!isTabActive(tab.id)"
                                            [class.hover:border-gray-300]="!isTabActive(tab.id)"
                                            (click)="switchTab(tab.id)">
                                            {{tab.label}}
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Contents -->
                <div id="tab-contents">
                    <!-- Comp√©tences Tab -->
                    <div class="tab-content active" id="skills-content" [class.active]="isTabActive('skills')">
                        <!-- Existing category grid below -->
                        <div class="grid md:grid-cols-2 gap-6">
                            <!-- Loop through filtered categories -->
                            <div *ngFor="let category of filteredCategories"
                                class="bg-white rounded-xl shadow overflow-hidden">
                                <div class="bg-indigo-600 px-4 py-3 flex justify-between items-center">
                                    <h3 class="text-lg font-medium text-white">{{ category.name }} ({{
                                        (domains[category.id!] || []).length }} comp√©tences)</h3>
                                </div>
                                <div class="p-4">
                                    <!-- Loop through domains for this category -->
                                    <div *ngFor="let domain of domains[category.id!]"
                                        class="skill-card bg-indigo-50 p-4 rounded-lg mb-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <h4 class="font-medium text-indigo-800">{{ domain.name }}</h4>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-sm font-medium text-gray-700">Progr√®s: {{
                                                domain.acquis_percentage }}%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" [style.width]="domain.acquis_percentage + '%'">
                                            </div>
                                        </div>
                                        <div class="mt-3 flex justify-between text-sm text-gray-600">
                                            <span>D√©but: {{ domain.start_date }}</span>
                                            <span>Derni√®re √©val: {{ domain.last_eval_date }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Statistiques Tab -->
                    <div class="tab-content" id="stats-content" [class.active]="isTabActive('stats')">
                        <!-- First row: 1 card full width -->
                        <div class="grid grid-cols-1 mb-6">
                            <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center chart-container">
                                <div class="w-full h-64">
                                    <canvas baseChart
                                        [data]="skillsChartData"
                                        [options]="skillsChartOptions"
                                        [type]="'doughnut'">
                                    </canvas>
                                </div>
                            </div>
                        </div>
                        <!-- Second row: 2 cards side by side -->
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center chart-container">
                                <div class="w-full h-64">
                                    <canvas baseChart
                                        [data]="progressChartData"
                                        [options]="progressChartOptions"
                                        [type]="'bar'">
                                    </canvas>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center chart-container">
                                <div class="w-full h-64">
                                    <canvas baseChart
                                        [data]="lineChartData"
                                        [options]="lineChartOptions"
                                        [type]="'line'">
                                    </canvas>
                                </div>
                            </div>
                        </div>
                        <!-- Third row: 1 card full width -->
                        <div class="grid grid-cols-1 mb-8">
                            <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center chart-container">
                                <div class="w-full h-64">
                                    <canvas baseChart
                                        [data]="polarChartData"
                                        [options]="polarChartOptions"
                                        [type]="'polarArea'">
                                    </canvas>
                                </div>
                            </div>
                        </div>
                        <!-- Additional Charts Section -->
                        <div class="grid md:grid-cols-2 gap-6 mb-8">
                            <!-- Skills Progress Overview -->
                            <div class="bg-white rounded-xl shadow-md p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-chart-line text-indigo-600 mr-2"></i>
                                    Aper√ßu des Progr√®s
                                </h3>
                                <div class="space-y-4">
                                    <div *ngFor="let category of filteredCategories" class="category-progress-card">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="font-medium text-gray-700">{{ category.name }}</span>
                                            <span class="text-sm text-gray-500">{{ (domains[category.id!] || []).length }} comp√©tences</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill"
                                                [style.width]="getCategoryProgress(category.id!) + '%'">
                                            </div>
                                        </div>
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>Progr√®s: {{ getCategoryProgress(category.id!) }}%</span>
                                            <span>Objectif: 85%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Recent Activity -->
                            <div class="bg-white rounded-xl shadow-md p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-clock text-green-600 mr-2"></i>
                                    Activit√© R√©cente
                                </h3>
                                <div class="space-y-4">
                                    <div *ngFor="let category of filteredCategories.slice(0, 3)" class="activity-item">
                                        <div class="flex items-start space-x-3">
                                            <div class="flex-shrink-0">
                                                <div class="activity-icon">
                                                    <i class="fas fa-star text-sm"></i>
                                                </div>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-medium text-gray-900">{{ category.name }}</p>
                                                <p class="text-sm text-gray-500">
                                                    {{ (domains[category.id!] || []).length }} comp√©tences √©valu√©es
                                                </p>
                                                <p class="text-xs text-gray-400">Derni√®re mise √† jour: {{ getLastUpdateDate() }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Goals Tab -->
                    <div class="tab-content" id="goals-content" [class.active]="isTabActive('goals')">
                        <app-goals 
                        [goals]="goals" 
                        (addGoalClicked)="openAddGoalModal()" 
                        (editGoalClicked)="openEditGoalModal($event)"
                        (toggleSubObjectiveStatus)="onToggleSubObjective($event)"
                        (deleteGoalClicked)="onDeleteGoal($event)"></app-goals>
                    </div>
                    <app-add-goal-modal
                        *ngIf="showGoalFormModal"
                        [isVisible]="showGoalFormModal"
                        [goalToEdit]="goalToEdit"
                        (close)="closeGoalFormModal()"
                        (goalSaved)="onGoalSaved($event)"
                        [currentProfileId]="currentProfileIdForModal"> 
                    </app-add-goal-modal>
                    <!-- Tab Goals -->

                    <!-- Strategies Tab -->
                    <div class="tab-content" id="strategies-content" class="tab-content"
                        [class.active]="isTabActive('strategies')">
                        <div class="bg-white rounded-xl shadow overflow-hidden">
                            <div class="bg-green-600 px-4 py-3">
                                <h3 class="text-lg font-medium text-white">Strat√©gies comportementales</h3>
                            </div>
                            <div class="p-4">
                                <div class="mb-6">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 mt-1">
                                            <div
                                                class="flex items-center justify-center h-6 w-6 rounded-full bg-green-100 text-green-800">
                                                <i class="fas fa-lightbulb text-sm"></i>
                                            </div>
                                        </div>
                                        <div class="ml-3">
                                            <h4 class="text-lg font-medium text-gray-800">Utilisation de renforcements
                                                positifs</h4>
                                            <p class="mt-1 text-gray-600">Syst√®me de r√©compenses imm√©diates pour les
                                                comportements souhait√©s.
                                                Utiliser des renfor√ßateurs vari√©s (jouets pr√©f√©r√©s, autocollants,
                                                activit√©s sp√©ciales).</p>
                                            <div class="mt-3">
                                                <span
                                                    class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mr-2">
                                                    <i class="fas fa-check-circle mr-1"></i> Actif
                                                </span>
                                                <span
                                                    class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                                                    <i class="fas fa-user mr-1"></i> Tous les intervenants
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 mt-1">
                                            <div
                                                class="flex items-center justify-center h-6 w-6 rounded-full bg-green-100 text-green-800">
                                                <i class="fas fa-lightbulb text-sm"></i>
                                            </div>
                                        </div>
                                        <div class="ml-3">
                                            <h4 class="text-lg font-medium text-gray-800">Sc√©narios sociaux pour les
                                                situations quotidiennes</h4>
                                            <p class="mt-1 text-gray-600">Cr√©ation d'histoires sociales illustr√©es pour
                                                pr√©parer Jean aux
                                                situations nouvelles ou difficiles (visite chez le m√©decin,
                                                anniversaire, etc.).</p>
                                            <div class="mt-3">
                                                <span
                                                    class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mr-2">
                                                    <i class="fas fa-check-circle mr-1"></i> Actif
                                                </span>
                                                <span
                                                    class="inline-block bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">
                                                    <i class="fas fa-user mr-1"></i> √âducateur sp√©cialis√©
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button
                                    class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:text-green-600 hover:border-green-300 transition flex items-center justify-center"
                                    (click)="openSigninDialog()">
                                    <i class="fas fa-plus mr-2"></i> Ajouter une nouvelle strat√©gie
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Tab -->
                    <div class="tab-content" id="notes-content" class="tab-content"
                        [class.active]="isTabActive('notes')">
                        <app-notes></app-notes>
                    </div>
                </div>
            </div>
        </body>

        <p-dialog header="Ajouter un enfant" [(visible)]="displayDialog" [modal]="true" [style]="{ width: '40vw' }">
            <div class="dialog-content">
                <div class="field">
                    <label for="firstName">Pr√©nom</label>
                    <input pInputText id="firstName" [(ngModel)]="newChild.first_name" placeholder="Pr√©nom" required />
                </div>
                <div class="field">
                    <label for="lastName">Nom</label>
                    <input pInputText id="lastName" [(ngModel)]="newChild.last_name" placeholder="Nom" required />
                </div>
                <div class="field">
                    <label for="birthDate">Date de naissance</label>
                    <input pInputText id="birthDate" type="date" [(ngModel)]="newChild.birth_date" required />
                </div>
                <div class="field">
                    <label>Genre</label>
                    <div class="gender-selector">
                        <!-- Male Option (M) -->
                        <div class="gender-option" [class.selected]="selectedChild!.gender === 'M'"
                            (click)="selectedChild!.gender = 'M'">
                            ‚ôÇ Male
                        </div>

                        <!-- Female Option (F) -->
                        <div class="gender-option" [class.selected]="selectedChild!.gender === 'F'"
                            (click)="selectedChild!.gender = 'F'">
                            ‚ôÄ Female
                        </div>
                    </div>
                </div>
                <div class="field">
                    <label for="diagnosis">Diagnostic</label>
                    <input pInputText id="diagnosis" [(ngModel)]="newChild.diagnosis" placeholder="Diagnostic" />
                </div>
                <div class="field">
                    <label for="notes">Notes</label>
                    <input pInputText id="notes" [(ngModel)]="newChild.notes" placeholder="Notes" />
                </div>
                <div class="field">
                    <label for="evaluationScore">Score d'√©valuation</label>
                    <input pInputText id="evaluationScore" type="number" [(ngModel)]="newChild.evaluation_score"
                        placeholder="Score (0-100)" />
                </div>

                <!-- <div class="field">
      <label for="imageUrl">URL de l'image</label>
      <input pInputText id="imageUrl" [(ngModel)]="newChild.image_url" placeholder="URL de l'image (optionnel)" />
    </div> -->
            </div>
            <ng-template pTemplate="footer">
                <p-button label="Annuler" styleClass="p-button-text" (click)="cancel()"></p-button>
                <p-button label="Ajouter" styleClass="p-button-primary" (click)="addChild()"
                    [style]="{ color: 'white' }"></p-button>
            </ng-template>
        </p-dialog>

        <p-dialog header="Modifier le profil" [(visible)]="displayEditDialog" [modal]="true" [style]="{width: '50vw'}"
            [draggable]="false" [resizable]="false">
            <div class="dialog-content">
                <div class="p-fluid">
                    <div class="field">
                        <label for="firstName">Pr√©nom</label>
                        <input pInputText id="firstName" [(ngModel)]="selectedChild!.first_name!" type="text"
                            required />
                    </div>
                    <div class="field">
                        <label for="lastName">Nom</label>
                        <input pInputText id="lastName" [(ngModel)]="selectedChild!.last_name!" type="text" required />
                    </div>
                    <div class="field">
                        <label for="birthDate">Date de naissance</label>
                        <input pInputText id="birthDate" [(ngModel)]="selectedChild!.birth_date" type="date" required />
                    </div>
                    <div class="field">
                        <label>Genre</label>
                        <div class="gender-selector">
                            <!-- Male Option (M) -->
                            <div class="gender-option" [class.selected]="selectedChild!.gender === 'M'"
                                (click)="selectedChild!.gender = 'M'">
                                ‚ôÇ Male
                            </div>

                            <!-- Female Option (F) -->
                            <div class="gender-option" [class.selected]="selectedChild!.gender === 'F'"
                                (click)="selectedChild!.gender = 'F'">
                                ‚ôÄ Female
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <label for="diagnosis">Diagnostic</label>
                        <input pInputText id="diagnosis" [(ngModel)]="selectedChild!.diagnosis" type="text" />
                    </div>
                    <div class="field">
                        <label for="notes">Notes</label>
                        <input pInputText id="notes" [(ngModel)]="selectedChild!.notes" type="text" />
                    </div>
                    <!-- <div class="field">
      <label for="imageUrl">URL de l'image</label>
      <input pInputText id="imageUrl" [(ngModel)]="selectedChild!.image_url" type="text" />
    </div> -->
                </div>
            </div>
            <ng-template pTemplate="footer">
                <button pButton type="button" label="Annuler" class="p-button-secondary"
                    (click)="cancelEdit()"></button>
                <button pButton type="button" label="Enregistrer" class="p-button-primary" style="color: white;"
                    (click)="saveChild()"></button>
            </ng-template>

        </p-dialog>

        <p-dialog header="Partager le profil" [(visible)]="afficherBoiteDialoguePartage" [modal]="true"
            [style]="{width: '500px'}">
            <div class="dialog-content">
                <div class="p-fluid">
                    <div class="field">
                        <label for="email">Email du parent</label>
                        <input pInputText id="email" [(ngModel)]="saisieEmail" placeholder="Entrez l'email du parent" (ngModelChange)="validateEmail()" />
                    </div>
                    <div *ngIf="saisieEmail && !isEmailValid" class="text-red-500 text-xs mt-1">Adresse email invalide.</div>
                    <div class="field">
                        <label for="access">Niveau d'acc√®s</label>
                        <p-dropdown id="access" [options]="optionsAcces" [(ngModel)]="accesSelectionne"
                            optionLabel="libelle" placeholder="S√©lectionner un acc√®s"></p-dropdown>
                    </div>
                </div>
            </div>
            <ng-template pTemplate="footer">
                <button pButton type="button" label="Annuler" class="p-button-secondary"
                    (click)="afficherBoiteDialoguePartage = false"></button>
                <button pButton type="button" label="Partager" class="p-button-primary" style="color: white;"
                    (click)="shareProfile()" [disabled]="!isEmailValid || loadingShare">
                    <ng-container *ngIf="loadingShare">
                      <i class="pi pi-spin pi-spinner mr-2"></i>
                    </ng-container>
                    Partager
                </button>
            </ng-template>

        </p-dialog>

    </main>
</div>