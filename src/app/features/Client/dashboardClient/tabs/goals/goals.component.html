<div class="bg-white rounded-xl shadow overflow-hidden">
  <div class="bg-blue-600 px-4 py-3">
    <h3 class="text-lg font-medium text-white">Objectifs de travail</h3>
  </div>
  <div class="p-4">

    <div *ngIf="goals.length > 0; else noGoalsFound">
      <div *ngFor="let goal of goals" class="mb-6 border-b border-gray-200 pb-6 last:border-b-0 last:pb-0">
        <div class="flex flex-col sm:flex-row sm:items-start mb-4">
          <div class="flex-shrink-0 mt-1 sm:mt-0 mr-3">
            <div class="flex items-center justify-center h-8 w-8 rounded-full bg-blue-100 text-blue-800">
              <i class="fas fa-bullseye text-sm"></i>
            </div>
          </div>
          <div class="flex-grow">
            <div class="flex items-center mb-1">
              <h4 class="text-xl font-bold text-gray-800">{{ goal.title }}</h4>
              <span class="ml-3 px-4 py-1 text-xs font-semibold rounded-full"
                    [ngClass]="{
                      'bg-red-100 text-red-800': goal.priority === 'high',
                      'bg-yellow-100 text-yellow-800': goal.priority === 'medium',
                      'bg-green-100 text-green-800': goal.priority === 'low'
                    }">
                {{ goal.priority | titlecase }}
              </span>
            </div>

            <p class="mt-1 text-gray-600 mb-2">{{ goal.description }}</p>
            <div class="flex items-center justify-between text-sm text-gray-500 mt-2">
              <div class="flex items-center">
                <i class="fas fa-calendar-alt mr-2"></i> Date cible: {{ formatDate(goal.target_date) }}
              </div>
              <div class="flex items-center space-x-3">
                <button (click)="onEditGoalClick(goal)"
                        class="text-blue-600 hover:text-blue-800 transition text-base">
                  <i class="fas fa-edit mr-1"></i> Modifier
                </button>
                <button (click)="onDeleteGoalClick(goal.id)"
                        class="text-red-600 hover:text-red-800 transition text-base">
                  <i class="fas fa-trash-alt mr-1"></i> Supprimer
                </button>
              </div>
            </div>

            <div class="mt-4"> <button (click)="onGoalClick(goal)"
                      [ngClass]="{
                        'bg-purple-600 hover:bg-purple-700 focus:ring-purple-500': isQuizAvailable(goal),
                        'bg-gray-400 cursor-not-allowed': !isQuizAvailable(goal)
                      }"
                      [disabled]="!isQuizAvailable(goal)"
                      [title]="getQuizAvailabilityMessage(goal)"
                      class="w-full py-2 px-4 text-white font-semibold rounded-md shadow-md
                             focus:outline-none focus:ring-2 focus:ring-offset-2
                             transition ease-in-out duration-150 text-base flex items-center justify-center">
                <i class="fas fa-question-circle mr-2"></i> Passer le Quiz
              </button>
            </div>

          </div>
        </div>

        <div class="flex items-center mt-4 mb-4 gap-4">
          <span class="text-sm text-gray-700 font-medium whitespace-nowrap">Progression: {{ calculateProgress(goal) }}%</span>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div class="bg-blue-600 h-3 rounded-full transition-all duration-500 ease-out"
                 [style.width]="calculateProgress(goal) + '%'"></div>
          </div>
        </div>

        <div *ngIf="goal.sub_objectives && goal.sub_objectives.length > 0" class="border-l-4 border-blue-200 pl-4 ml-3 pt-2">
          <h5 class="font-medium text-gray-700 mb-3">Sous-objectifs:</h5>
          <ul class="space-y-3">
            <li *ngFor="let subObj of goal.sub_objectives" class="flex items-center">
              <div class="flex-shrink-0 mr-3">
                <button (click)="onToggleSubObjective(goal.id, subObj.id, subObj.is_completed)"
                        [disabled]="!isQuizAvailable(goal)"
                        [ngClass]="{
                          'bg-blue-100 text-blue-800': isQuizAvailable(goal),
                          'bg-gray-200 text-gray-500': !isQuizAvailable(goal),
                          'cursor-not-allowed': !isQuizAvailable(goal)
                        }"
                        [title]="getSubObjectiveTooltip(goal)"
                        class="flex items-center justify-center h-6 w-6 rounded-full transition-colors duration-200">
                  <i class="fas" [ngClass]="subObj.is_completed ? 'fa-check' : 'fa-spinner'"></i>
                </button>
              </div>
              <div class="flex-grow">
                <span class="text-gray-800 text-base" [class.line-through]="subObj.is_completed">
                  {{ subObj.description }}
                </span>
              </div>
            </li>
          </ul>
        </div>
        <p *ngIf="!goal.sub_objectives || goal.sub_objectives.length === 0" class="text-gray-500 text-sm italic border-l-4 border-gray-100 pl-4 ml-3 pt-2">
          Aucun sous-objectif défini.
        </p>

      </div>
    </div>

    <ng-template #noGoalsFound>
      <div class="text-center py-10 text-gray-500">
        <p class="text-lg">Aucun objectif trouvé. Cliquez sur "Ajouter un nouvel objectif" pour commencer !</p>
        <i class="far fa-clipboard text-6xl mt-4"></i>
      </div>
    </ng-template>

    <button (click)="onAddGoalClick()"
      class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:text-blue-600 hover:border-blue-300 transition flex items-center justify-center mt-6 text-base font-medium">
      <i class="fas fa-plus mr-2"></i> Ajouter un nouvel objectif
    </button>
  </div>
</div>