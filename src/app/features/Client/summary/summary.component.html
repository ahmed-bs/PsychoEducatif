<div class="head-title">
  <div class="left">
    <h1>{{ 'skills_summary.title' | translate }}</h1>
    <ul class="breadcrumb">
      <li>
        <a href="#">{{ 'skills_summary.breadcrumb.dashboard' | translate }}</a>
      </li>
      <li><i class="bx bx-chevron-right"></i></li>
      <li>
        <a class="active" href="#">{{ 'skills_summary.breadcrumb.skills_summary' | translate }}</a>
      </li>
    </ul>
  </div>
</div>

<div class="summary-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>{{ 'skills_summary.loading' | translate }}</p>
    </div>
  </div>

  <!-- Error State -->
  <!-- <div *ngIf="error" class="error-container">
    <div class="error-message">
      <i class="pi pi-exclamation-triangle"></i>
      {{ 'skills_summary.error' | translate: { error: error } }}
    </div>
  </div> -->

  <!-- Action Bar -->
  <div class="action-bar">
    <button 
      type="button"
      class="filter-toggle-btn"
      (click)="toggleSidebar()"
      [class.active]="isSidebarOpen"
      pTooltip="{{ 'skills_summary.filters.toggle_filters' | translate }}"
      tooltipPosition="bottom">
      <i class="pi" [class.pi-filter]="!isSidebarOpen" [class.pi-times]="isSidebarOpen"></i>
      <span class="btn-label">{{ 'skills_summary.filters.toggle_filters' | translate }}</span>
    </button>
    
    <div class="export-buttons">
      <button
        pButton
        type="button"
        icon="pi pi-file-excel"
        (click)="exportExcel()"
        [disabled]="categoryDataForTable.length === 0"
        class="export-btn excel-btn"
        pTooltip="{{ 'skills_summary.export.excel' | translate }}"
        tooltipPosition="bottom"
      ></button>
      <button
        pButton
        type="button"
        icon="pi pi-file-pdf"
        (click)="exportPdf()"
        [disabled]="categoryDataForTable.length === 0"
        class="export-btn pdf-btn"
        pTooltip="{{ 'skills_summary.export.pdf' | translate }}"
        tooltipPosition="bottom"
      ></button>
    </div>
  </div>

  <!-- Sidebar Overlay -->
  <div 
    class="sidebar-overlay" 
    *ngIf="isSidebarOpen"
    (click)="closeSidebar()">
  </div>

  <!-- Filter Sidebar -->
  <div class="filter-sidebar" [class.open]="isSidebarOpen">
    <div class="sidebar-header">
      <h3 class="sidebar-title">
        <i class="pi pi-filter"></i>
        {{ 'skills_summary.filters.title' | translate }}
      </h3>
      <button 
        type="button"
        class="sidebar-close-btn"
        (click)="closeSidebar()">
        <i class="pi pi-times"></i>
      </button>
    </div>

    <div class="sidebar-content">
      <div class="filters-container">
        <!-- Basic Filters Group -->
        <div class="filters-group">
          <h4 class="filters-group-title">{{ 'skills_summary.filters.basic_filters' | translate }}</h4>
          <div class="filters-row">
            <div class="filter-section">
              <label for="status-filter" class="filter-label">
                {{ 'skills_summary.filters.status' | translate }}:
              </label>
              <select 
                id="status-filter" 
                class="filter-select"
                [(ngModel)]="selectedFilterStatus">
                <option *ngFor="let status of filterStatuses" [value]="status.value">
                  {{ status.label }}
                </option>
              </select>
            </div>

            <div class="filter-section">
              <label for="module-filter" class="filter-label">
                {{ 'skills_summary.filters.module' | translate }}:
              </label>
              <select 
                id="module-filter" 
                class="filter-select"
                [(ngModel)]="selectedFilterModule">
                <option *ngFor="let module of filterModules" [value]="module.value">
                  {{ module.label }}
                </option>
              </select>
            </div>

            <div class="filter-section">
              <label for="item-status-filter" class="filter-label">
                {{ 'skills_summary.filters.item_status.label' | translate }}:
              </label>
              <select 
                id="item-status-filter" 
                class="filter-select"
                [(ngModel)]="selectedFilterItemStatus">
                <option *ngFor="let itemStatus of filterItemStatuses" [value]="itemStatus.value">
                  {{ itemStatus.label }}
                </option>
              </select>
            </div>
          </div>
        </div>

        <!-- Date Filters Group -->
        <div class="filters-group date-filters-group">
          <h4 class="filters-group-title">{{ 'skills_summary.filters.date_filters' | translate }}</h4>
          <div class="filters-row date-filters-row">
            <div class="filter-section date-filter-section">
              <label for="start-date-filter" class="filter-label">
                {{ 'skills_summary.filters.start_date' | translate }}:
              </label>
              <div class="date-picker-wrapper">
                <p-calendar 
                  id="start-date-filter"
                  [(ngModel)]="startDate"
                  (onSelect)="onDateChange()"
                  (onClear)="onDateChange()"
                  [showIcon]="true"
                  dateFormat="yy-mm-dd"
                  [showTime]="true"
                  [hourFormat]="'24'"
                  [placeholder]="'skills_summary.filters.start_date_placeholder' | translate"
                  inputStyleClass="date-filter-input"
                  [inputStyle]="{'width': '100%'}"
                  [appendTo]="'body'"
                  [baseZIndex]="10000">
                </p-calendar>
              </div>
            </div>

            <div class="filter-section date-filter-section">
              <label for="end-date-filter" class="filter-label">
                {{ 'skills_summary.filters.end_date' | translate }}:
              </label>
              <div class="date-picker-wrapper">
                <p-calendar 
                  id="end-date-filter"
                  [(ngModel)]="endDate"
                  (onSelect)="onDateChange()"
                  (onClear)="onDateChange()"
                  [showIcon]="true"
                  dateFormat="yy-mm-dd"
                  [showTime]="true"
                  [hourFormat]="'24'"
                  [placeholder]="'skills_summary.filters.end_date_placeholder' | translate"
                  inputStyleClass="date-filter-input"
                  [inputStyle]="{'width': '100%'}"
                  [appendTo]="'body'"
                  [baseZIndex]="10000">
                </p-calendar>
              </div>
            </div>
          </div>
          
          <!-- Date Filter Error Message -->
          <div *ngIf="dateFilterError" class="date-filter-error">
            <i class="pi pi-exclamation-triangle"></i>
            <span>{{ dateFilterError }}</span>
          </div>
        </div>
      </div>

      <!-- Apply Filters Button -->
      <div class="filter-actions">
        <button 
          type="button"
          class="apply-filters-btn"
          (click)="onApplyFilters()">
          <i class="pi pi-filter"></i>
          {{ 'skills_summary.filters.apply_filters' | translate }}
        </button>
        <button 
          type="button"
          class="reset-filters-btn"
          (click)="resetFilters()">
          <i class="pi pi-refresh"></i>
          {{ 'skills_summary.filters.reset_filters' | translate }}
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content Wrapper -->
  <div class="main-content-wrapper" [class.sidebar-open]="isSidebarOpen">

  <!-- Desktop Table View (hidden on mobile) -->
  <div class="desktop-view">
    <div class="table-container">
      <p-table
        [value]="categoryDataForTable"
        [paginator]="true"
        [rows]="5"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[5, 10, 20, 50]"
        [currentPageReportTemplate]="'skills_summary.table.current_page_report' | translate"
        [responsive]="true"
        styleClass="modern-table p-datatable-sm"
        [expandedRowKeys]="expandedCategories"
        dataKey="category"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 3rem"></th>
            <th pSortableColumn="category" class="category-header">
              <div class="header-content">
                <i class="pi pi-tag header-icon"></i>
                {{ 'skills_summary.table.category' | translate }}
                <p-sortIcon field="category"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="totalDomains" class="domains-header">
              <div class="header-content">
                <i class="pi pi-sitemap header-icon"></i>
                {{ 'skills_summary.table.total_domains' | translate }}
                <p-sortIcon field="totalDomains"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="totalItemsOverall" class="items-header">
              <div class="header-content">
                <i class="pi pi-list header-icon"></i>
                {{ 'skills_summary.table.total_items_overall' | translate }}
                <p-sortIcon field="totalItemsOverall"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="overallProgress" class="progress-header">
              <div class="header-content">
                <i class="pi pi-chart-line header-icon"></i>
                {{ 'skills_summary.table.overall_progress' | translate }}
                <p-sortIcon field="overallProgress"></p-sortIcon>
              </div>
            </th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-categoryData let-expanded="expanded">
          <tr class="category-row">
            <td>
              <button
                type="button"
                pButton
                pRipple
                [pRowToggler]="categoryData"
                class="p-button-text p-button-rounded p-button-plain expand-button"
                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
              ></button>
            </td>
            <td class="category-name">
              <div class="category-content">
                <i class="pi pi-folder category-icon"></i>
                                 <span class="category-text">{{ getCategoryDisplayName(categoryData) }}</span>
              </div>
            </td>
            <td class="domains-count">
              <div class="count-badge domains-badge">
                <i class="pi pi-sitemap count-icon"></i>
                <span>{{ categoryData.totalDomains }}</span>
              </div>
            </td>
            <td class="items-count">
              <div class="count-badge items-badge">
                <i class="pi pi-list count-icon"></i>
                <span>{{ categoryData.totalItemsOverall }}</span>
              </div>
            </td>
            <td class="progress-cell">
              <div class="progress-container-table">
                <p-progressBar
                  [value]="categoryData.overallProgress"
                  [showValue]="false"
                  styleClass="custom-progress"
                ></p-progressBar>
                <span class="progress-text-table">{{ categoryData.overallProgress }}%</span>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="rowexpansion" let-categoryData>
          <tr class="expansion-row">
            <td [attr.colspan]="5">
              <div class="expansion-content">
                <div class="expansion-header">
                                     <h5 class="expansion-title" [innerHTML]="'skills_summary.table.domains_header' | translate: { category: getCategoryDisplayName(categoryData) }"></h5>
                  <div class="expansion-divider"></div>
                </div>
                <div class="domains-table-container">
                  <p-table
                    [value]="categoryData.domains"
                    dataKey="domain"
                    styleClass="modern-nested-table p-datatable-sm"
                    [responsive]="true"
                    [scrollable]="true"
                    scrollHeight="flex"
                    [tableStyle]="{ 'min-width': '40rem' }"
                  >
                    <ng-template pTemplate="header">
                      <tr>
                        <th class="domain-header">
                          <div class="header-content">
                            <i class="pi pi-globe header-icon"></i>
                            {{ 'skills_summary.table.domain' | translate }}
                            <p-sortIcon field="domain"></p-sortIcon>
                          </div>
                        </th>
                        <th class="total-header">
                          <div class="header-content">
                            <i class="pi pi-list header-icon"></i>
                            {{ 'skills_summary.table.total_items' | translate }}
                            <p-sortIcon field="totalItems"></p-sortIcon>
                          </div>
                        </th>
                        <th class="acquired-header">
                          <div class="header-content">
                            <i class="pi pi-check-circle header-icon"></i>
                            {{ 'skills_summary.table.acquired' | translate }}
                            <p-sortIcon field="acquired"></p-sortIcon>
                          </div>
                        </th>
                        <th class="partial-header">
                          <div class="header-content">
                            <i class="pi pi-clock header-icon"></i>
                            {{ 'skills_summary.table.partial' | translate }}
                            <p-sortIcon field="partial"></p-sortIcon>
                          </div>
                        </th>
                        <th class="not-acquired-header">
                          <div class="header-content">
                            <i class="pi pi-times-circle header-icon"></i>
                            {{ 'skills_summary.table.not_acquired' | translate }}
                            <p-sortIcon field="notAcquired"></p-sortIcon>
                          </div>
                        </th>
                        <th class="not-evaluated-header">
                          <div class="header-content">
                            <i class="pi pi-question-circle header-icon"></i>
                            {{ 'skills_summary.table.not_evaluated' | translate }}
                            <p-sortIcon field="notEvaluated"></p-sortIcon>
                          </div>
                        </th>
                        <th class="progress-header">
                          <div class="header-content">
                            <i class="pi pi-chart-bar header-icon"></i>
                            {{ 'skills_summary.table.progress_percentage' | translate }}
                            <p-sortIcon field="progressPercentage"></p-sortIcon>
                          </div>
                        </th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-domainData>
                      <tr class="domain-row">
                        <td class="domain-name">
                          <div class="domain-content">
                            <i class="pi pi-globe domain-icon"></i>
                            <span class="domain-text">{{ getDomainDisplayName(domainData) }}</span>
                          </div>
                        </td>
                        <td class="total-count">
                          <div class="count-badge total-badge">
                            <span>{{ domainData.totalItems }}</span>
                          </div>
                        </td>
                        <td class="acquired-count">
                          <span class="statut-badge statut-acquise">{{ domainData.acquired }}</span>
                        </td>
                        <td class="partial-count">
                          <span class="statut-badge statut-partiel">{{ domainData.partial }}</span>
                        </td>
                        <td class="not-acquired-count">
                          <span class="statut-badge statut-non-acquise">{{ domainData.notAcquired }}</span>
                        </td>
                        <td class="not-evaluated-count">
                          <span class="statut-badge statut-non-evalue">{{ domainData.notEvaluated }}</span>
                        </td>
                        <td class="domain-progress">
                          <div class="progress-container-table">
                            <p-progressBar
                              [value]="domainData.progressPercentage"
                              [showValue]="false"
                              styleClass="custom-progress"
                            ></p-progressBar>
                            <span class="progress-text-table">{{ domainData.progressPercentage }}%</span>
                          </div>
                        </td>
                      </tr>
                      <tr class="domain-items-detail-row">
                        <td [attr.colspan]="7" class="p-0">
                          <div class="items-detail-container">
                            <div class="items-detail-header">
                              <h6 class="items-detail-title" [innerHTML]="'skills_summary.domain_items.header' | translate: { domain: getDomainDisplayName(domainData), status: getFilterStatusLabel(selectedFilterStatus) }"></h6>
                              <p-toggleButton
                                [(ngModel)]="domainItemsVisibility[domainData.domain]"
                                [onLabel]="'skills_summary.domain_items.hide_items' | translate"
                                [offLabel]="'skills_summary.domain_items.show_items' | translate"
                                [style]="{ 'width': '10em' }"
                                styleClass="p-button-sm p-button-outlined item-toggle-button">
                              </p-toggleButton>
                            </div>

                            <div *ngIf="isDomainItemsVisible(domainData.domain)" class="items-grid">
                              <div *ngFor="let item of domainData.profileItems" class="item-card">
                                <div class="item-header">
                                  <span class="item-name">{{ getItemLanguageField(item, 'name') }}</span>
                                  <span class="statut-badge text-xs font-semibold px-2.5 py-0.5 rounded-full" [ngClass]="{
                                      'statut-acquise': item.etat === 'ACQUIS',
                                      'statut-partiel': item.etat === 'PARTIEL',
                                      'statut-non-acquise': item.etat === 'NON_ACQUIS',
                                      'statut-non-evalue': item.etat === 'NON_COTE'
                                  }">{{ 'skills_summary.status_labels.' + item.etat | translate }}</span>
                                </div>
                                <div class="item-content">
                                  <p *ngIf="getItemLanguageField(item, 'comentaire')" class="item-comment">
                                    <i class="pi pi-comment comment-icon"></i>
                                    {{ getItemLanguageField(item, 'comentaire') }}
                                  </p>
                                  <p *ngIf="!item.commentaire" class="item-no-comment">
                                    <i class="pi pi-info-circle info-icon"></i>
                                    {{ 'skills_summary.domain_items.no_comment' | translate }}
                                  </p>
                                </div>
                              </div>
                            </div>

                            <div *ngIf="domainData.profileItems.length === 0" class="no-items-message" [innerHTML]="'skills_summary.domain_items.no_items_message' | translate: { status: getFilterStatusLabel(selectedFilterStatus) }"></div>
                          </div>
                        </td>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                      <tr>
                        <td colspan="7" class="text-center empty-message">{{ 'skills_summary.table.no_domains_message' | translate }}</td>
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5" class="text-center empty-message">{{ 'skills_summary.table.no_categories_message' | translate }}</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Mobile/Tablet Card View -->
  <div class="mobile-view">
    <div class="categories-grid">
      <div *ngFor="let category of categoryDataForTable" class="category-card">
        <div class="category-card-header">
          <div class="category-info">
            <div class="category-icon-wrapper">
              <i class="pi pi-folder"></i>
            </div>
            <div class="category-details">
                             <h3 class="category-title">{{ getCategoryDisplayName(category) }}</h3>
              <div class="category-stats">
                <span class="stat-item">
                  <i class="pi pi-sitemap"></i>
                  {{ category.totalDomains }} {{ 'skills_summary.table.total_domains' | translate }}
                </span>
                <span class="stat-item">
                  <i class="pi pi-list"></i>
                  {{ category.totalItemsOverall }} {{ 'skills_summary.table.total_items_overall' | translate }}
                </span>
              </div>
            </div>
          </div>
          <div class="category-progress">
            <div class="progress-circle">
              <div class="progress-circle-inner">
                <span class="progress-percentage">{{ category.overallProgress }}%</span>
              </div>
            </div>
          </div>
        </div>

        <div class="category-card-body">
          <div class="domains-list">
            <div *ngFor="let domain of category.domains" class="domain-item">
              <div class="domain-header" (click)="toggleDomainItems(domain.domain)">
                <div class="domain-info">
                  <i class="pi pi-globe"></i>
                  <span class="domain-name">{{ getDomainDisplayName(domain) }}</span>
                </div>
                <div class="domain-stats">
                  <div class="domain-progress-bar">
                    <div class="progress-fill" [style.width.%]="domain.progressPercentage"></div>
                  </div>
                  <span class="domain-progress-text">{{ domain.progressPercentage }}%</span>
                  <i class="pi" [class.pi-chevron-down]="isDomainItemsVisible(domain.domain)" [class.pi-chevron-right]="!isDomainItemsVisible(domain.domain)"></i>
                </div>
              </div>

              <div *ngIf="isDomainItemsVisible(domain.domain)" class="domain-details">
                <div class="domain-summary">
                  <div class="summary-item">
                    <span class="summary-label">{{ 'skills_summary.table.total_items' | translate }}</span>
                    <span class="summary-value">{{ domain.totalItems }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">{{ 'skills_summary.table.acquired' | translate }}</span>
                    <span class="summary-value acquired">{{ domain.acquired }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">{{ 'skills_summary.table.partial' | translate }}</span>
                    <span class="summary-value partial">{{ domain.partial }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">{{ 'skills_summary.table.not_acquired' | translate }}</span>
                    <span class="summary-value not-acquired">{{ domain.notAcquired }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">{{ 'skills_summary.table.not_evaluated' | translate }}</span>
                    <span class="summary-value not-evaluated">{{ domain.notEvaluated }}</span>
                  </div>
                </div>

                <div class="items-section">
                  <h4 class="items-section-title">{{ 'skills_summary.domain_items.header' | translate: { domain: getDomainDisplayName(domain), status: getFilterStatusLabel(selectedFilterStatus) } }}</h4>
                  <div class="items-list">
                    <div *ngFor="let item of domain.profileItems" class="item-card-mobile">
                      <div class="item-header-mobile">
                        <span class="item-name-mobile">{{ getItemLanguageField(item, 'name') }}</span>
                        <span class="status-badge-mobile" [ngClass]="{
                          'status-acquired': item.etat === 'ACQUIS',
                          'status-partial': item.etat === 'PARTIEL',
                          'status-not-acquired': item.etat === 'NON_ACQUIS',
                          'status-not-evaluated': item.etat === 'NON_COTE'
                        }">{{ 'skills_summary.status_labels.' + item.etat | translate }}</span>
                      </div>
                                             <div *ngIf="getItemLanguageField(item, 'comentaire')" class="item-comment-mobile">
                         <i class="pi pi-comment"></i>
                         {{ getItemLanguageField(item, 'comentaire') }}
                       </div>
                       <div *ngIf="!item.comentaire" class="item-no-comment-mobile">
                        <i class="pi pi-info-circle"></i>
                        {{ 'skills_summary.domain_items.no_comment' | translate }}
                      </div>
                    </div>
                  </div>
                  <div *ngIf="domain.profileItems.length === 0" class="no-items-message-mobile">
                    {{ 'skills_summary.domain_items.no_items_message' | translate: { status: getFilterStatusLabel(selectedFilterStatus) } }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Pagination -->
    <div *ngIf="categoryDataForTable.length > 5" class="mobile-pagination">
      <p-paginator
        [rows]="5"
        [totalRecords]="categoryDataForTable.length"
        [showCurrentPageReport]="true"
        [currentPageReportTemplate]="'skills_summary.table.current_page_report' | translate"
        styleClass="mobile-paginator">
      </p-paginator>
    </div>
  </div>
  </div>
</div>